{"file_path": "registry.py", "content": "\"\"\"\nProject registry for managing registered projects.\n\nStores project metadata in ~/.eri-rpg/registry.json\nEach project has a name, path, language, and index status.\n\"\"\"\n\nfrom dataclasses import dataclass, field\nfrom datetime import datetime\nfrom typing import Dict, List, Optional\nimport json\nfrom pathlib import Path\nimport os\n\n\ndef detect_project_language(path: str) -> str:\n    \"\"\"Auto-detect project language from files in the project root.\n\n    Checks for common language indicators:\n    - Cargo.toml -> rust\n    - pyproject.toml / setup.py / *.py -> python\n    - *.c, *.h, Makefile, CMakeLists.txt -> c\n\n    Returns:\n        Language string: 'python', 'c', 'rust', or 'unknown'\n    \"\"\"\n    path = os.path.abspath(os.path.expanduser(path))\n\n    # Check for language-specific files\n    if os.path.exists(os.path.join(path, \"Cargo.toml\")):\n        return \"rust\"\n\n    if os.path.exists(os.path.join(path, \"pyproject.toml\")) or \\\n       os.path.exists(os.path.join(path, \"setup.py\")):\n        return \"python\"\n\n    # Count files to determine majority language\n    py_count = 0\n    c_count = 0\n    rs_count = 0\n\n    for root, dirs, files in os.walk(path):\n        # Skip hidden and build dirs\n        dirs[:] = [d for d in dirs if not d.startswith(\".\") and d not in (\"target\", \"build\", \"node_modules\", \"__pycache__\")]\n\n        for f in files:\n            if f.endswith(\".py\"):\n                py_count += 1\n            elif f.endswith((\".c\", \".h\", \".cpp\", \".hpp\")):\n                c_count += 1\n            elif f.endswith(\".rs\"):\n                rs_count += 1\n\n        # Early exit if we've sampled enough\n        if py_count + c_count + rs_count > 10:\n            break\n\n    # Determine by majority\n    if c_count >= max(py_count, rs_count):\n        return \"c\"\n    elif rs_count >= max(py_count, c_count):\n        return \"rust\"\n    elif py_count > 0:\n        return \"python\"\n\n    return \"unknown\"\n\n\n@dataclass\nclass Project:\n    \"\"\"A registered project.\"\"\"\n    name: str\n    path: str  # Absolute path to project root\n    lang: str  # \"python\" | \"rust\" | \"c\"\n    indexed_at: Optional[datetime] = None\n    graph_path: str = \"\"  # Path to graph.json\n\n    def __post_init__(self):\n        if not self.graph_path:\n            self.graph_path = os.path.join(self.path, \".eri-rpg\", \"graph.json\")\n\n    def to_dict(self) -> dict:\n        return {\n            \"name\": self.name,\n            \"path\": self.path,\n            \"lang\": self.lang,\n            \"indexed_at\": self.indexed_at.isoformat() if self.indexed_at else None,\n            \"graph_path\": self.graph_path,\n        }\n\n    @classmethod\n    def from_dict(cls, d: dict) -> \"Project\":\n        indexed_at = None\n        if d.get(\"indexed_at\"):\n            indexed_at = datetime.fromisoformat(d[\"indexed_at\"])\n        return cls(\n            name=d[\"name\"],\n            path=d[\"path\"],\n            lang=d[\"lang\"],\n            indexed_at=indexed_at,\n            graph_path=d.get(\"graph_path\", \"\"),\n        )\n\n    def is_indexed(self) -> bool:\n        \"\"\"Check if project has been indexed.\"\"\"\n        return self.indexed_at is not None and os.path.exists(self.graph_path)\n\n    def index_age_days(self) -> Optional[float]:\n        \"\"\"Days since last index, or None if never indexed.\"\"\"\n        if not self.indexed_at:\n            return None\n        delta = datetime.now() - self.indexed_at\n        return delta.total_seconds() / 86400\n\n\n@dataclass\nclass Registry:\n    \"\"\"Registry of all known projects.\"\"\"\n    projects: Dict[str, Project] = field(default_factory=dict)\n    config_dir: str = field(default_factory=lambda: os.path.expanduser(\"~/.eri-rpg\"))\n\n    def __post_init__(self):\n        self._registry_path = os.path.join(self.config_dir, \"registry.json\")\n\n    def add(self, name: str, path: str, lang: str) -> Project:\n        \"\"\"Add a new project to the registry.\n\n        Args:\n            name: Unique project name\n            path: Path to project root\n            lang: Programming language\n\n        Returns:\n            The created Project\n\n        Raises:\n            ValueError: If project with name already exists\n            FileNotFoundError: If path doesn't exist\n        \"\"\"\n        if name in self.projects:\n            raise ValueError(f\"Project '{name}' already exists\")\n\n        abs_path = os.path.abspath(os.path.expanduser(path))\n        if not os.path.isdir(abs_path):\n            raise FileNotFoundError(f\"Path does not exist: {abs_path}\")\n\n        project = Project(name=name, path=abs_path, lang=lang)\n        self.projects[name] = project\n        self.save()\n        return project\n\n    def remove(self, name: str) -> bool:\n        \"\"\"Remove a project from the registry.\n\n        Args:\n            name: Project name to remove\n\n        Returns:\n            True if removed, False if not found\n        \"\"\"\n        if name not in self.projects:\n            return False\n\n        del self.projects[name]\n        self.save()\n        return True\n\n    def get(self, name: str) -> Optional[Project]:\n        \"\"\"Get a project by name.\"\"\"\n        return self.projects.get(name)\n\n    def list(self) -> List[Project]:\n        \"\"\"List all registered projects.\"\"\"\n        return list(self.projects.values())\n\n    def save(self) -> None:\n        \"\"\"Save registry to disk.\"\"\"\n        Path(self.config_dir).mkdir(parents=True, exist_ok=True)\n\n        data = {\n            \"version\": \"1.0.0\",\n            \"projects\": {k: v.to_dict() for k, v in self.projects.items()},\n        }\n\n        with open(self._registry_path, \"w\") as f:\n            json.dump(data, f, indent=2)\n\n    def load(self) -> None:\n        \"\"\"Load registry from disk.\"\"\"\n        if not os.path.exists(self._registry_path):\n            self.projects = {}\n            return\n\n        with open(self._registry_path, \"r\") as f:\n            data = json.load(f)\n\n        self.projects = {\n            k: Project.from_dict(v)\n            for k, v in data.get(\"projects\", {}).items()\n        }\n\n    def update_indexed(self, name: str) -> None:\n        \"\"\"Mark a project as indexed now.\"\"\"\n        if name in self.projects:\n            self.projects[name].indexed_at = datetime.now()\n            self.save()\n\n    @classmethod\n    def get_instance(cls) -> \"Registry\":\n        \"\"\"Get or create the global registry instance.\"\"\"\n        registry = cls()\n        registry.load()\n        return registry\n", "timestamp": "2026-01-26T19:38:53.444508"}