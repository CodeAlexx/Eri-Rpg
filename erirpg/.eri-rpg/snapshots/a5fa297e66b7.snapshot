{"file_path": "install.py", "content": "\"\"\"\nOne-command setup for Claude Code integration.\n\nUsage:\n    eri-rpg install    # Install commands and hooks\n    eri-rpg uninstall  # Remove everything cleanly\n\"\"\"\n\nimport os\nimport json\nimport shutil\nfrom pathlib import Path\nfrom typing import Optional\n\n\ndef get_erirpg_root() -> Path:\n    \"\"\"Get the EriRPG installation root.\"\"\"\n    return Path(__file__).parent.parent\n\n\ndef install_claude_code(verbose: bool = True) -> bool:\n    \"\"\"\n    Install EriRPG commands and hooks for Claude Code.\n\n    Returns:\n        True if successful\n    \"\"\"\n    home = Path.home()\n    claude_dir = home / \".claude\"\n    commands_dir = claude_dir / \"commands\" / \"eri\"\n    settings_file = claude_dir / \"settings.json\"\n\n    erirpg_root = get_erirpg_root()\n\n    # Create directories\n    commands_dir.mkdir(parents=True, exist_ok=True)\n\n    # Copy command files\n    src_commands = erirpg_root / \".claude\" / \"commands\" / \"eri\"\n    commands_installed = []\n\n    if src_commands.exists():\n        for cmd in src_commands.glob(\"*.md\"):\n            shutil.copy(cmd, commands_dir / cmd.name)\n            commands_installed.append(f\"/eri:{cmd.stem}\")\n            if verbose:\n                print(f\"  Installed: /eri:{cmd.stem}\")\n    else:\n        # Create default commands if source doesn't exist\n        _create_default_commands(commands_dir, verbose)\n        commands_installed = [\"/eri:execute\", \"/eri:quick\", \"/eri:status\"]\n\n    # Update settings.json with hooks\n    hooks_config = {\n        \"PreToolUse\": [{\n            \"matcher\": \"Edit|Write|MultiEdit\",\n            \"hooks\": [{\n                \"type\": \"command\",\n                \"command\": f\"python3 {erirpg_root}/erirpg/hooks/pretooluse.py\",\n                \"timeout\": 5\n            }]\n        }],\n        \"PreCompact\": [{\n            \"matcher\": \".*\",\n            \"hooks\": [{\n                \"type\": \"command\",\n                \"command\": f\"python3 {erirpg_root}/erirpg/hooks/precompact.py\",\n                \"timeout\": 10\n            }]\n        }],\n        \"SessionStart\": [{\n            \"matcher\": \".*\",\n            \"hooks\": [{\n                \"type\": \"command\",\n                \"command\": f\"python3 {erirpg_root}/erirpg/hooks/sessionstart.py\",\n                \"timeout\": 5\n            }]\n        }]\n    }\n\n    if settings_file.exists():\n        try:\n            settings = json.loads(settings_file.read_text())\n        except json.JSONDecodeError:\n            settings = {}\n    else:\n        settings = {}\n\n    # Merge hooks (don't overwrite existing non-erirpg hooks)\n    existing_hooks = settings.get(\"hooks\", {})\n\n    for hook_type, hook_list in hooks_config.items():\n        if hook_type not in existing_hooks:\n            existing_hooks[hook_type] = []\n\n        # Remove any existing erirpg hooks\n        existing_hooks[hook_type] = [\n            h for h in existing_hooks[hook_type]\n            if \"erirpg\" not in str(h.get(\"hooks\", [{}])[0].get(\"command\", \"\"))\n        ]\n\n        # Add new erirpg hooks\n        existing_hooks[hook_type].extend(hook_list)\n\n    settings[\"hooks\"] = existing_hooks\n    settings_file.write_text(json.dumps(settings, indent=2))\n\n    if verbose:\n        print(f\"\\nUpdated: {settings_file}\")\n        print(f\"\\nInstalled hooks:\")\n        print(f\"  PreToolUse  - Enforces EriRPG workflow\")\n        print(f\"  PreCompact  - Saves state before compaction\")\n        print(f\"  SessionStart - Reminds about incomplete runs\")\n        print(f\"\\nCommands: {', '.join(commands_installed)}\")\n        print(f\"\\nRestart Claude Code to load changes.\")\n\n    return True\n\n\ndef uninstall_claude_code(verbose: bool = True) -> bool:\n    \"\"\"\n    Remove EriRPG from Claude Code.\n\n    Returns:\n        True if successful\n    \"\"\"\n    home = Path.home()\n    commands_dir = home / \".claude\" / \"commands\" / \"eri\"\n    settings_file = home / \".claude\" / \"settings.json\"\n\n    removed_items = []\n\n    # Remove commands\n    if commands_dir.exists():\n        shutil.rmtree(commands_dir)\n        removed_items.append(f\"Commands: {commands_dir}\")\n        if verbose:\n            print(f\"Removed: {commands_dir}\")\n\n    # Remove hooks from settings\n    if settings_file.exists():\n        try:\n            settings = json.loads(settings_file.read_text())\n\n            if \"hooks\" in settings:\n                for hook_type in [\"PreToolUse\", \"PreCompact\", \"SessionStart\"]:\n                    if hook_type in settings[\"hooks\"]:\n                        original_count = len(settings[\"hooks\"][hook_type])\n                        settings[\"hooks\"][hook_type] = [\n                            h for h in settings[\"hooks\"][hook_type]\n                            if \"erirpg\" not in str(h.get(\"hooks\", [{}])[0].get(\"command\", \"\"))\n                        ]\n                        if len(settings[\"hooks\"][hook_type]) < original_count:\n                            removed_items.append(f\"Hook: {hook_type}\")\n\n                # Clean up empty hook lists\n                settings[\"hooks\"] = {\n                    k: v for k, v in settings[\"hooks\"].items() if v\n                }\n                if not settings[\"hooks\"]:\n                    del settings[\"hooks\"]\n\n                settings_file.write_text(json.dumps(settings, indent=2))\n                if verbose:\n                    print(f\"Updated: {settings_file}\")\n        except (json.JSONDecodeError, KeyError):\n            pass\n\n    if verbose:\n        if removed_items:\n            print(f\"\\nRemoved:\")\n            for item in removed_items:\n                print(f\"  {item}\")\n        else:\n            print(\"Nothing to remove.\")\n        print(\"\\nEriRPG removed from Claude Code.\")\n\n    return True\n\n\ndef _create_default_commands(commands_dir: Path, verbose: bool = True) -> None:\n    \"\"\"Create default slash commands if source doesn't exist.\"\"\"\n\n    execute_cmd = '''# /eri:execute - Execute EriRPG workflow\n\nRun the EriRPG agent loop for the current task.\n\n## Usage\n\nWhen the user wants to make code changes, use this workflow:\n\n1. **Start a run**: `eri-rpg goal-plan <project> \"<goal>\"`\n2. **Execute steps**: Follow the generated spec\n3. **Complete**: `eri-rpg goal-status <project>`\n\n## Quick Fix Mode\n\nFor simple single-file edits:\n\n```bash\neri-rpg quick <project> <file> \"<description>\"\n# Make edits...\neri-rpg quick-done <project>\n```\n'''\n\n    quick_cmd = '''# /eri:quick - Quick fix mode\n\nStart a quick fix for a single file.\n\n## Usage\n\n```bash\neri-rpg quick <project> <file> \"<description>\"\n```\n\nThen edit the file. When done:\n\n```bash\neri-rpg quick-done <project>\n```\n\nTo cancel and restore:\n\n```bash\neri-rpg quick-cancel <project>\n```\n'''\n\n    status_cmd = '''# /eri:status - Show EriRPG status\n\nCheck current EriRPG state.\n\n## Commands\n\n```bash\n# Show registered projects\neri-rpg list\n\n# Show runs for a project\neri-rpg runs <project>\n\n# Show quick fix status\neri-rpg quick-status <project>\n\n# Cleanup old runs\neri-rpg cleanup <project> --prune\n```\n'''\n\n    (commands_dir / \"execute.md\").write_text(execute_cmd)\n    (commands_dir / \"quick.md\").write_text(quick_cmd)\n    (commands_dir / \"status.md\").write_text(status_cmd)\n\n    if verbose:\n        print(\"  Created: /eri:execute\")\n        print(\"  Created: /eri:quick\")\n        print(\"  Created: /eri:status\")\n\n\ndef check_installation() -> dict:\n    \"\"\"\n    Check current installation status.\n\n    Returns:\n        Dict with installation status\n    \"\"\"\n    home = Path.home()\n    claude_dir = home / \".claude\"\n    commands_dir = claude_dir / \"commands\" / \"eri\"\n    settings_file = claude_dir / \"settings.json\"\n\n    status = {\n        \"commands_installed\": False,\n        \"commands\": [],\n        \"hooks_installed\": False,\n        \"hooks\": [],\n    }\n\n    # Check commands\n    if commands_dir.exists():\n        cmds = list(commands_dir.glob(\"*.md\"))\n        if cmds:\n            status[\"commands_installed\"] = True\n            status[\"commands\"] = [f\"/eri:{c.stem}\" for c in cmds]\n\n    # Check hooks\n    if settings_file.exists():\n        try:\n            settings = json.loads(settings_file.read_text())\n            hooks = settings.get(\"hooks\", {})\n\n            for hook_type in [\"PreToolUse\", \"PreCompact\", \"SessionStart\"]:\n                if hook_type in hooks:\n                    for h in hooks[hook_type]:\n                        cmd = h.get(\"hooks\", [{}])[0].get(\"command\", \"\")\n                        if \"erirpg\" in cmd:\n                            status[\"hooks_installed\"] = True\n                            status[\"hooks\"].append(hook_type)\n        except (json.JSONDecodeError, KeyError):\n            pass\n\n    return status\n\n\n# CLI integration\nif __name__ == \"__main__\":\n    import sys\n\n    if len(sys.argv) < 2:\n        print(\"Usage: python install.py [install|uninstall|status]\")\n        sys.exit(1)\n\n    cmd = sys.argv[1]\n\n    if cmd == \"install\":\n        install_claude_code()\n    elif cmd == \"uninstall\":\n        uninstall_claude_code()\n    elif cmd == \"status\":\n        status = check_installation()\n        print(\"EriRPG Installation Status:\")\n        print(f\"  Commands: {status['commands'] if status['commands_installed'] else 'Not installed'}\")\n        print(f\"  Hooks: {status['hooks'] if status['hooks_installed'] else 'Not installed'}\")\n    else:\n        print(f\"Unknown command: {cmd}\")\n        sys.exit(1)\n", "timestamp": "2026-01-26T22:25:03.553167"}